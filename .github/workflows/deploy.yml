name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚‚å¯èƒ½

env:
  REGION: ${{ secrets.REGION }}
  BACKEND_IMAGE: ${{ secrets.BACKEND_IMAGE_NAME }}
  FRONTEND_IMAGE: ${{ secrets.FRONTEND_IMAGE_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Backend image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --push \
          --tag ${{ env.BACKEND_IMAGE }}:latest \
          --tag ${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
          -f backend/Dockerfile.prod \
          ./backend

    - name: Build and push Frontend image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --push \
          --tag ${{ env.FRONTEND_IMAGE }}:latest \
          --tag ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
          -f frontend/Dockerfile.prod \
          ./frontend

    - name: Deploy Backend to Cloud Run
      run: |
        gcloud run deploy todo-backend \
          --image=${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --timeout=300 \
          --memory=512Mi \
          --cpu=1

    - name: Get Backend URL
      id: backend-url
      run: |
        BACKEND_URL=$(gcloud run services describe todo-backend \
          --region=${{ env.REGION }} \
          --format='value(status.url)')
        echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "Backend URL: $BACKEND_URL"

    - name: Deploy Frontend to Cloud Run
      run: |
        gcloud run deploy todo-frontend \
          --image=${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars="NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }}" \
          --timeout=300 \
          --memory=512Mi \
          --cpu=1

    - name: Get Frontend URL
      run: |
        FRONTEND_URL=$(gcloud run services describe todo-frontend \
          --region=${{ env.REGION }} \
          --format='value(status.url)')
        echo "âœ… Deployment successful!"
        echo "Frontend: $FRONTEND_URL"
        echo "Backend: ${{ steps.backend-url.outputs.url }}"

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Service URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** $(gcloud run services describe todo-frontend --region=${{ env.REGION }} --format='value(status.url)')" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend:** ${{ steps.backend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
